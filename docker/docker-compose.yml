version: "3.7"

services:
  traefik-reverse-proxy:
    container_name: traefik
    image: traefik:v2.4
    command:
      - --api=true
      - --api.dashboard=true
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --entrypoints.websecure.http.tls.domains[0].main=vaccini.vivedo.me
      - --entrypoints.websecure.http.tls.domains[0].sans=*.vaccini.vivedo.me
      - --log=true
      - --log.level=ERROR
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --providers.docker.network=web
      - "--certificatesresolvers.secure.acme.email=edoardo.viviani@gmail.com"
      - "--certificatesresolvers.secure.acme.storage=/acme.json"
      - "--certificatesresolvers.secure.acme.tlschallenge=true"

    restart: unless-stopped
    ports:
      - '80:80'
      - '443:443'
    expose:
        - 8080
    labels:
      - traefik.http.middlewares.httpsredirect.redirectscheme.scheme=https
      - traefik.enable=true
      - traefik.network=web
      - traefik.port=8080
      - traefik.http.routers.traefik.service=api@internal
      - traefik.http.routers.traefik.rule=Host(`traefik.vaccini.vivedo.me`)

      # global redirect to https  
      - "traefik.http.routers.http-catchall.rule=hostregexp(`{host:[a-z-.]+}`)"
      - "traefik.http.routers.http-catchall.entrypoints=web"
      - "traefik.http.routers.http-catchall.middlewares=redirect-to-https"
      - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"

      

#      - traefik.http.routers.traefik.middlewares=traefik-auth
#      - traefik.http.middlewares.traefik-auth.basicauth.users=vivedo:$apr1$akexzyps$DJxf6DsmdKhF1tGNp6s091
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ../acme.json:/acme.json
    networks:
      - web

networks:
  web:
      external: true

  